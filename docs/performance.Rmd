---
title: "Performance Tests"
author: "David Hugh-Jones <davidhughjones@gmail.com>"
date: "`r Sys.Date()`"
output: rmarkdown::html_document

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Speed tests

On my Macbook Air, standard broadband connection.

## Pre-downloaded

`clipr` is a small package with few versions. `mice` is a larger package which requires compilation, with more
dependencies.

```{r}
library(apicheck)
library(microbenchmark)
library(ggplot2)
options(repos = "https://cran.rstudio.com")

test_A <- function (search) when_fn_exists("clipr::dr_clipr", search = search, progress = FALSE)
test_B <- function (search) when_fn_exists("mice::ncc", min_version = "2.20", search = search, progress = FALSE)

# Pre-cache and show results:
test_A("all") 
test_B("all")

cached <- microbenchmark(
        clipr_all      = test_A("all"),
        clipr_parallel = test_A("parallel"),
        mice_all       = test_B("all"),
        mice_parallel  = test_B("parallel"),
        times = 20
      )

cached

autoplot(cached, log = FALSE)

```

## With download


```{r}

clear <- function (fn) {
  function (search){fn(search); clear_package_cache()}
}

clear_package_cache()

uncached <- microbenchmark(
        clipr_all      = clear(test_A)("all"),
        clipr_parallel = clear(test_A)("parallel"),
        mice_all       = clear(test_B)("all"),
        mice_parallel  = clear(test_B)("parallel"),
        times = 5
      )

uncached

autoplot(uncached, log = FALSE)
```
